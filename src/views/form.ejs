<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Choose week and number of adults</title>
    <link rel="stylesheet" href="/style.css">
    <style>
      .spinner-overlay {
        position: fixed;
        top: 20px;
        right: 30px;
        z-index: 9999;
        pointer-events: none;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #1976d2;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        animation: spin 1s linear infinite;
      }
      .spinner-check {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        font-size: 2em;
        color: #43a047;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 0 4px #ccc;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
</head>
<body>
    <div id="spinner-overlay" class="spinner-overlay" style="display:none;">
      <div class="spinner" id="spinner"></div>
      <div class="spinner-check" id="spinner-check" style="display:none;">&#10003;</div>
    </div>
    <div style="display: flex; flex-direction: row; gap: 1em; justify-content: center; align-items: flex-start; min-height: 90vh;">
        <!-- Left panel: search/price form -->
        <div class="form-box" style="flex: 1 1 350px; min-width: 320px; max-width: 420px;">
            <h1>Recherche de prix Booking.com</h1>
            <form method="POST" action="/prices" id="search-form">
                <label for="start_date">Semaine</label>
                <input type="date" id="start_date" name="start_date" value="<%= (typeof today !== 'undefined' ? today : (new Date()).toISOString().slice(0,10)) %>" required>
                <label for="adults">Nombre d'adultes</label>
                <select id="adults" name="adults">
                    <% for(let i=1; i<=3; i++) { %>
                        <option value="<%= i %>" <%= i === defaultAdults ? 'selected' : '' %>><%= i %></option>
                    <% } %>
                </select>
                <button type="submit">Voir les prix</button>
            </form>
        </div>

        <!-- Middle panel: hotel management -->
        <div class="form-box" style="flex: 1 1 350px; min-width: 320px; max-width: 420px;">
            <h2>Hôtels suivis</h2>
            <table style="width:100%; border-collapse:collapse; font-size:0.96em;">
                <thead>
                    <tr>
                        <th style="text-align:left; padding:2px 4px; font-weight:600;">Nom</th>
                        <th style="text-align:left; padding:2px 4px; font-weight:600;">ID Xotelo</th>
                        <th style="width:1%;"></th>
                    </tr>
                </thead>
                <tbody>
                    <% hotels.forEach(function(hotel, idx) { %>
                        <tr style="height: 1.2em;">
                            <td style="padding:1px 4px;"><b><%= hotel.name %></b></td>
                            <td style="padding:1px 4px;"><code><%= hotel.key %></code></td>
                            <td style="padding:1px 2px;">
                                <form method="POST" action="/hotels/delete" style="display:inline;">
                                    <input type="hidden" name="hotel_idx" value="<%= idx %>">
                                    <button type="submit" style="background:#b00;color:#fff;padding:0.10em 0.5em;border:none;border-radius:4px;cursor:pointer;font-size:0.93em;">Supprimer</button>
                                </form>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>

            <h2>Add a hotel</h2>
            <div style="text-align: center; margin-bottom: 0.7em;">
              <a href="https://www.tripadvisor.fr/" target="_blank" rel="noopener">Recherche un hôtel sur Tripadvisor</a>
            </div>
            <form method="POST" action="/hotels/add" style="margin-bottom:2em;">
                <label for="hotel_name">Name</label>
                <input type="text" id="hotel_name" name="hotel_name" required>
                <label for="hotel_url">Tripadvisor URL</label>
                <input type="text" id="hotel_url" name="hotel_url" required placeholder="Coller l'URL Tripadvisor">
                <input type="hidden" id="hotel_key" name="hotel_key">
                <button type="submit">Add hotel</button>
            </form>
            <script>
            // Fonction JS pour extraire l'ID Tripadvisor depuis l'URL
            function extractTripadvisorHotelKey(url) {
              if (!url || url.trim() === "") {
                return null;
              }
              const re1 = /Hotel_Review-/g;
              const re2 = /-Reviews/g;
              const match1 = re1.exec(url);
              const match2 = re2.exec(url);
              if (!match1 || !match2) {
                return null;
              }
              return url.substring(match1.index + 13, match2.index);
            }
            // Remplit automatiquement le champ caché hotel_key lors de la saisie de l'URL
            document.addEventListener('DOMContentLoaded', function() {
              var urlInput = document.getElementById('hotel_url');
              var keyInput = document.getElementById('hotel_key');
              urlInput.addEventListener('input', function() {
                var key = extractTripadvisorHotelKey(urlInput.value);
                keyInput.value = key || '';
                if (!key && urlInput.value.length > 0) {
                  urlInput.style.borderColor = '#b00';
                } else {
                  urlInput.style.borderColor = '';
                }
              });
              // Validation à la soumission
              urlInput.form.addEventListener('submit', function(e) {
                var key = extractTripadvisorHotelKey(urlInput.value);
                if (!key) {
                  e.preventDefault();
                  urlInput.style.borderColor = '#b00';
                  alert("URL Tripadvisor invalide : impossible d'extraire l'ID hôtel.");
                } else {
                  keyInput.value = key;
                }
              });
            });
            </script>
            </form>
        </div>

        <!-- Third panel: app explanation -->
        <div class="form-box" style="flex: 1 1 350px; min-width: 320px; max-width: 420px;">
            <h2>À propos de l'application</h2>
            <p>
                Cette application vous permet de suivre les prix des hôtels sur Booking.com pour une sélection d'hôtels que vous ajoutez à la liste.<br><br>
                <b>Fonctionnement&nbsp;:</b>
                <ul>
                    <li>Sélectionnez une semaine et le nombre d'adultes pour rechercher les prix disponibles.</li>
                    <li>Ajoutez des hôtels à suivre en collant leur URL Tripadvisor (l'identifiant sera extrait automatiquement).</li>
                    <li>Supprimez des hôtels de la liste à tout moment.</li>
                </ul>
                Les prix affichés sont récupérés en temps réel. <br><br>
                Si vous rencontrez un soucis, vous pouvez contacter Rubens à l'adresse : <br> <a href="mailto:rubens.torres-lacaze@telecom-sudparis.eu">rubens.torres-lacaze@telecom-sudparis.eu</a>
            </p>
        </div>
    </div>
</body>
<script>
  // Spinner logique : affichage lors de la soumission, check à la fin du chargement
  document.addEventListener('DOMContentLoaded', function() {
    var spinnerOverlay = document.getElementById('spinner-overlay');
    var spinner = document.getElementById('spinner');
    var spinnerCheck = document.getElementById('spinner-check');
    function showSpinner() {
      spinnerOverlay.style.display = '';
      spinner.style.display = '';
      spinnerCheck.style.display = 'none';
    }
    function showCheck() {
      spinner.style.display = 'none';
      spinnerCheck.style.display = '';
      setTimeout(function() {
        spinnerOverlay.style.display = 'none';
      }, 900);
    }
    // Affiche le spinner à la soumission de n'importe quel formulaire
    document.querySelectorAll('form').forEach(function(form) {
      form.addEventListener('submit', function() {
        showSpinner();
      });
    });
    // Affiche le check à la fin du chargement de la page (si spinner visible)
    window.addEventListener('pageshow', function() {
      if (spinnerOverlay.style.display !== 'none') {
        showCheck();
      }
    });
    window.addEventListener('load', function() {
      if (spinnerOverlay.style.display !== 'none') {
        showCheck();
      }
    });
  });
</script>
</html>
